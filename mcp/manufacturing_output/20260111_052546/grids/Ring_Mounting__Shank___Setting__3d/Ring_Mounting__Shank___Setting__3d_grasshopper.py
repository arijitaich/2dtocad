"""
Grasshopper Python Script - Parametric Surface Grid
Generated by mesh_to_cad_grid.py

Usage in Grasshopper:
1. Add a "Python" component
2. Paste this script
3. Connect inputs:
   - mesh: The input mesh geometry
   - square_size: Number slider (e.g., 0.1 to 10)
   - density: Integer slider for sampling density
4. Output: Grid curves ready for further manipulation
"""

import Rhino.Geometry as rg
import rhinoscriptsyntax as rs
import math

# Inputs from Grasshopper
# mesh = input mesh
# square_size = size of each square (float)
# density = sampling density (int)

def get_tangent_vectors(normal):
    """Get two tangent vectors perpendicular to normal."""
    if abs(normal.X) < 0.9:
        ref = rg.Vector3d(1, 0, 0)
    else:
        ref = rg.Vector3d(0, 1, 0)
    
    tangent1 = rg.Vector3d.CrossProduct(normal, ref)
    tangent1.Unitize()
    
    tangent2 = rg.Vector3d.CrossProduct(normal, tangent1)
    tangent2.Unitize()
    
    return tangent1, tangent2

def create_square_at_point(point, normal, size):
    """Create a square curve centered at point, tangent to surface."""
    t1, t2 = get_tangent_vectors(normal)
    
    half = size / 2.0
    
    v1 = point + half * t1 + half * t2
    v2 = point - half * t1 + half * t2
    v3 = point - half * t1 - half * t2
    v4 = point + half * t1 - half * t2
    
    # Create closed polyline
    pts = [rg.Point3d(v1), rg.Point3d(v2), rg.Point3d(v3), rg.Point3d(v4), rg.Point3d(v1)]
    return rg.PolylineCurve([rg.Point3d(p) for p in pts])

# Main execution
squares = []

if mesh and square_size > 0:
    # Get mesh faces and sample points
    mesh_faces = mesh.Faces
    mesh_normals = mesh.FaceNormals
    
    # Sample points on mesh surface
    sample_count = density * density if density else 100
    
    # Use mesh face centers
    for i in range(mesh_faces.Count):
        if i % max(1, mesh_faces.Count // sample_count) == 0:
            face = mesh_faces[i]
            center = mesh_faces.GetFaceCenter(i)
            normal = mesh_normals[i]
            
            sq = create_square_at_point(center, normal, square_size)
            if sq:
                squares.append(sq)

# Output
a = squares  # Connect to Grasshopper output
